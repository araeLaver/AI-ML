# Finance RAG API - Docker Compose Configuration
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose up -d --build      # Rebuild and start
#   docker-compose logs -f api        # View API logs
#   docker-compose down               # Stop all services
#   docker-compose --profile dev up   # Include development services

version: "3.9"

services:
  # ==========================================================================
  # Finance RAG API Service
  # ==========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: finance-rag-api:latest
    container_name: finance-rag-api
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - APP_ENV=${APP_ENV:-production}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DART_API_KEY=${DART_API_KEY:-}
      - OLLAMA_API_URL=http://ollama:11434
      - LLM_MODEL=${LLM_MODEL:-llama3.2:latest}
      - CHROMA_DB_PATH=/app/db
      - CHROMA_COLLECTION_NAME=finance_docs
      - REDIS_URL=redis://redis:6379/0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - chromadb_data:/app/db
      - logs_data:/app/logs
      - models_data:/app/models
    depends_on:
      ollama:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ==========================================================================
  # Streamlit UI
  # ==========================================================================
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile
      target: streamlit
    image: finance-rag-streamlit:latest
    container_name: finance-rag-streamlit
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    environment:
      - API_URL=http://api:8000
      - GROQ_API_KEY=${GROQ_API_KEY:-}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  # ==========================================================================
  # Background Worker (DART Sync, Scheduled Tasks)
  # ==========================================================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: worker
    image: finance-rag-worker:latest
    container_name: finance-rag-worker
    environment:
      - APP_ENV=worker
      - DART_API_KEY=${DART_API_KEY:-}
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_DB_PATH=/app/db
      - SYNC_INTERVAL=${SYNC_INTERVAL:-3600}
    volumes:
      - chromadb_data:/app/db
      - logs_data:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rag-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G

  # ==========================================================================
  # Ollama LLM Service
  # ==========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: finance-rag-ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama_models:/root/.ollama
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    # GPU support (uncomment if using NVIDIA GPU)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # ==========================================================================
  # Redis (Caching & Task Queue)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: finance-rag-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # Nginx (Reverse Proxy)
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: finance-rag-nginx
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - api
      - streamlit
    networks:
      - rag-network
    restart: unless-stopped
    profiles:
      - production

  # ==========================================================================
  # Development Services
  # ==========================================================================
  api-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: finance-rag-api-dev
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=development
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - chromadb_data:/app/db
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rag-network
    profiles:
      - dev

# ==========================================================================
# Networks
# ==========================================================================
networks:
  rag-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  chromadb_data:
    driver: local
  ollama_models:
    driver: local
  redis_data:
    driver: local
  logs_data:
    driver: local
  models_data:
    driver: local
  nginx_logs:
    driver: local
