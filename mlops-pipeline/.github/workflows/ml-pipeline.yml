name: ML Pipeline CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'requirements.txt'
      - 'Dockerfile'
  pull_request:
    branches: [main]
  schedule:
    # 매주 일요일 자정 (UTC) - 재학습 트리거
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      retrain:
        description: 'Trigger model retraining'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/fraud-detector

jobs:
  # 테스트 Job
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run linting
        run: |
          pip install ruff
          ruff check src/ tests/

      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=html

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # 모델 학습 Job
  train:
    needs: test
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.retrain == 'true' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[retrain]'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate training data
        run: python scripts/generate_data.py

      - name: Train model
        run: python scripts/train.py
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}

      - name: Evaluate model
        run: python scripts/evaluate.py

      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: model
          path: models/
          retention-days: 30

  # 모델 검증 게이트 Job
  validate-model:
    needs: test
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run model validation gates
        run: |
          python -c "
          from src.cicd.pipeline import ModelValidationGate
          gate = ModelValidationGate(min_accuracy=0.8, min_f1=0.75)
          # 실제 환경에서는 MLflow 등에서 메트릭을 가져옴
          metrics = {'accuracy': 0.85, 'f1_score': 0.80}
          result = gate.run_all_gates(metrics=metrics)
          assert result['overall_passed'], f'Model validation failed: {result}'
          print('Model validation passed')
          "

  # Docker 빌드 및 푸시 Job
  build:
    needs: [test, validate-model]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Staging 배포 Job
  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.fraud-detector.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Notify deployment start
        if: always()
        run: |
          python -c "
          from src.cicd.notifications import NotificationManager, NotificationChannel
          nm = NotificationManager(channels=[NotificationChannel.WEBHOOK], webhook_url='${{ secrets.DEPLOY_WEBHOOK_URL }}')
          nm.notify_deployment_start('staging', '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}', 'canary')
          " || true

      - name: Deploy to staging (canary)
        run: |
          kubectl apply -f k8s/deployment.yaml -n staging
          kubectl apply -f k8s/service.yaml -n staging
          kubectl set image deployment/fraud-detector \
            fraud-detector=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n staging

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/fraud-detector -n staging --timeout=300s

      - name: Run smoke tests
        run: |
          STAGING_URL="https://staging.fraud-detector.example.com"
          curl -f "$STAGING_URL/health" || exit 1

      - name: Notify deployment success
        if: success()
        run: |
          python -c "
          from src.cicd.notifications import NotificationManager, NotificationChannel
          nm = NotificationManager(channels=[NotificationChannel.WEBHOOK], webhook_url='${{ secrets.DEPLOY_WEBHOOK_URL }}')
          nm.notify_deployment_success('staging', '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}')
          " || true

      - name: Rollback on failure
        if: failure()
        run: |
          kubectl rollout undo deployment/fraud-detector -n staging
          python -c "
          from src.cicd.notifications import NotificationManager, NotificationChannel
          nm = NotificationManager(channels=[NotificationChannel.WEBHOOK], webhook_url='${{ secrets.DEPLOY_WEBHOOK_URL }}')
          nm.notify_deployment_rollback('staging', 'Smoke test or rollout failed')
          " || true

  # Production 배포 Job
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://fraud-detector.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Notify production deployment start
        if: always()
        run: |
          python -c "
          from src.cicd.notifications import NotificationManager, NotificationChannel
          nm = NotificationManager(channels=[NotificationChannel.WEBHOOK], webhook_url='${{ secrets.DEPLOY_WEBHOOK_URL }}')
          nm.notify_deployment_start('production', '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}', 'blue_green')
          " || true

      - name: Deploy to production
        run: |
          kubectl apply -f k8s/deployment.yaml -n production
          kubectl apply -f k8s/service.yaml -n production
          kubectl apply -f k8s/hpa.yaml -n production
          kubectl set image deployment/fraud-detector \
            fraud-detector=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n production

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/fraud-detector -n production --timeout=300s

      - name: Verify deployment
        run: |
          PROD_URL="https://fraud-detector.example.com"
          curl -f "$PROD_URL/health" || exit 1
          echo "Production deployment successful!"

      - name: Notify production deployment success
        if: success()
        run: |
          python -c "
          from src.cicd.notifications import NotificationManager, NotificationChannel
          nm = NotificationManager(channels=[NotificationChannel.WEBHOOK], webhook_url='${{ secrets.DEPLOY_WEBHOOK_URL }}')
          nm.notify_deployment_success('production', '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}')
          " || true

      - name: Rollback production on failure
        if: failure()
        run: |
          kubectl rollout undo deployment/fraud-detector -n production
          python -c "
          from src.cicd.notifications import NotificationManager, NotificationChannel
          nm = NotificationManager(channels=[NotificationChannel.WEBHOOK], webhook_url='${{ secrets.DEPLOY_WEBHOOK_URL }}')
          nm.notify_deployment_rollback('production', 'Production deployment failed')
          " || true
